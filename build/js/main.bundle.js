(()=>{"use strict";const e=document.querySelector("#card").content.querySelector(".popup"),t={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Доврец"},r=document.querySelector(".map__filters"),o=document.querySelector(".ad-form"),a=r.querySelectorAll("select"),n=document.querySelectorAll("fieldset");r.classList.add("ad-form--disabled"),o.classList.add("ad-form--disabled");const c=e=>{e.disabled=!0},s=e=>{e.disabled=!1};a.forEach(c),n.forEach(c);const l=window.L,i=35.6895,d=139.69171,u=document.querySelector("#address"),p=l.layerGroup(),m=l.map("map-canvas").on("load",(()=>{r.classList.remove("ad-form--disabled"),o.classList.remove("ad-form--disabled"),a.forEach(s),n.forEach(s)})).setView({lat:i,lng:d},9);l.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(m);const f=l.icon({iconUrl:"/img/main-pin.svg",iconSize:[52,52],iconAnchor:[26,52]}),y=l.icon({iconUrl:"/img/pin.svg",iconSize:[40,40],iconAnchor:[20,40]}),v=l.marker({lat:i,lng:d},{draggable:!0,icon:f}),h=v.getLatLng(),g=r=>{p.clearLayers(),r.slice(0,10).forEach((r=>{const o=l.marker({lat:r.location.lat,lng:r.location.lng},{icon:y});o.bindPopup((r=>{const o=e.cloneNode(!0),a=o.querySelector(".popup__avatar"),n=o.querySelector(".popup__title"),c=o.querySelector(".popup__text--address"),s=o.querySelector(".popup__text--price"),l=o.querySelector(".popup__type"),i=o.querySelector(".popup__text--capacity"),d=o.querySelector(".popup__text--time"),u=o.querySelector(".popup__description"),p=o.querySelector(".popup__features"),m=o.querySelector(".popup__photos");var f,y;return r.author.avatar?a.src=r.author.avatar:a.remove(),r.offer.title?n.textContent=r.offer.title:n.remove(),r.offer.address?c.textContent=r.offer.address:c.remove(),r.offer.price?s.textContent=r.offer.price+" ₽/ночь":s.remove(),r.offer.type?l.textContent=t[r.offer.type]:l.remove(),r.offer.rooms&&r.offer.guests?i.textContent=`${y=r.offer.rooms,1===y&&(y+=" комната"),y>1&&y<5&&(y+=" комнаты"),y>=5&&y<=20&&(y+=" комнат"),y} для ${f=r.offer.guests,f+(1===f?" гостя":" гостей")}`:i.remove(),r.offer.checkin&&r.offer.checkout?d.textContent=`Заезд после ${r.offer.checkin} выезд до ${r.offer.checkout}`:d.remove(),r.offer.description?u.textContent=r.offer.description:u.remove(),r.offer.features?((e,t)=>{e.innerHTML="";for(let r=0;r<t.length;r++){const o=document.createElement("li");o.classList.add("popup__feature",`popup__feature--${t[r]}`),e.appendChild(o)}})(p,r.offer.features):p.remove(),r.offer.photos?((e,t)=>{e.innerHTML="";for(let r=0;r<t.length;r++){const o=document.createElement("img");o.className="popup__photo",o.width="45",o.height="40",o.alt="Фотография жилья",o.src=t[r],e.appendChild(o)}})(m,r.offer.photos):m.remove(),o})(r)),p.addLayer(o)}))};p.addTo(m),v.addTo(m);const S=(e,t)=>{u.value=`${e.toFixed(5)}, ${t.toFixed(5)}`};S(h.lat,h.lng),v.on("move",(e=>{const t=e.target.getLatLng();S(t.lat,t.lng)}));const q=({url:e,method:t="GET",headers:r=new Headers,body:o=null})=>fetch(`https://22.javascript.pages.academy/keksobooking${e}`,{method:t,headers:r,body:o}).then((e=>{if(e.ok)return e.json();throw new Error("`${response.status}: ${response.statusText}`")})),L=(e,t)=>q({url:"/data"}).then(e).catch(t),E=e=>"ESC"===e.key||"Escape"===e.key,w=document.querySelector("main"),C=document.querySelector("#success").content.querySelector(".success"),b=document.querySelector("#error").content.querySelector(".error"),k=(e,t)=>{e.remove(),document.removeEventListener("keydown",t)},x=()=>{document.addEventListener("keydown",V),b.querySelector(".error__message").textContent="Ошибка размещения объявления",b.addEventListener("click",T),w.appendChild(b)},V=e=>{E(e)&&(e.preventDefault(),k(b,V))},T=()=>{k(b,V),b.removeEventListener("click",T)},$=e=>{E(e)&&(e.preventDefault(),k(C,$))},A=()=>{k(C,$),C.removeEventListener("click",A)},D=document.querySelector(".map__filters"),M=D.querySelector("#housing-type"),j=D.querySelector("#housing-price"),F=D.querySelector("#housing-rooms"),H=D.querySelector("#housing-guests"),U=(e,t,r)=>"any"===r.value||e.offer[t].toString()===(r.value||"any"),z=e=>U(e,"type",M)&&U(e,"rooms",F)&&U(e,"guests",H)&&(e=>{switch(j.value){case"middle":return e.offer.price<=5e4&&e.offer.price>=1e4;case"low":return e.offer.price<1e4;case"high":return e.offer.price>5e4}return!0})(e)&&(e=>{const t=Array.from(D.querySelectorAll('input[type="checkbox"]:checked'));return!t.length||t.every((t=>e.offer.features.includes(t.value)))})(e),N=e=>{g(e),D.addEventListener("change",_.debounce((()=>{p.clearLayers(),g(e.filter(z))}),500))},O=document.querySelector(".ad-form-header__preview").querySelector("img").src,G=["gif","jpg","jpeg","png"],P=document.querySelector(".ad-form"),R=P.querySelector("#avatar"),W=P.querySelector(".ad-form-header__preview").querySelector("img"),B=P.querySelector("#images"),I=P.querySelector(".ad-form__photo");I.style.width="auto",I.style.minWidth="70px",I.style.marginTop="2px";const J=(e,t,r)=>{e.addEventListener("change",(e=>{const o=e.target.files[0],a=o.type.toLowerCase();if(G.some((e=>a.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(e=>{r(e,t)})),e.readAsDataURL(o)}}))};J(R,W,((e,t)=>{t.src=e.target.result})),J(B,I,((e,t)=>{const r=document.createElement("img");r.className="popup__photo",r.width=70,r.alt="Фотография жилья",r.src=e.target.result,t.appendChild(r)}));const K=document.querySelector(".ad-form"),Q=K.querySelector("#type"),X=K.querySelector("#price"),Y=K.querySelector("#timein"),Z=K.querySelector("#timeout"),ee=K.querySelector("#room_number"),te=K.querySelector("#capacity"),re=Array.from(te.options),oe=document.querySelector("#title"),ae=document.querySelector("#price"),ne={1:["1"],2:["1","2"],3:["1","2","3"],100:["0"]},ce={bungalow:0,flat:1e3,house:5e3,palace:1e4},se=()=>{re.forEach((e=>{e.disabled=!ne[ee.value].includes(e.value),e.selected=!e.disabled}))};se(),ee.addEventListener("change",(()=>{se()}));const le=()=>{const e=oe.value.length;oe.validity.tooShort?oe.setCustomValidity("Ещё "+(30-e)+" симв., бро!"):oe.validity.tooLong?oe.setCustomValidity("Удали лишние "+(e-100)+" симв., бро!"):oe.validity.valueMissing?oe.setCustomValidity("Обязательное поле, бро!"):oe.setCustomValidity("")};oe.addEventListener("invalid",(()=>{le()})),oe.addEventListener("input",(()=>{le(),oe.reportValidity()}));const ie=()=>{ae.validity.valueMissing?ae.setCustomValidity("Обязательное поле, бро!"):ae.validity.rangeUnderflow?ae.setCustomValidity("Нужно больше золота! ("+ae.min+")"):ae.validity.rangeOverflow?ae.setCustomValidity("Ну это тумач!"):ae.setCustomValidity("")};ae.addEventListener("invalid",(()=>{ie()})),ae.addEventListener("input",(()=>{ie(),ae.reportValidity()})),Q.addEventListener("change",(()=>{let e=Q.value;X.placeholder=ce[e],X.min=ce[e]})),Y.addEventListener("change",(()=>{Z.value=Y.value})),Z.addEventListener("change",(()=>{Y.value=Z.value}));const de=()=>{K.reset(),D.reset(),L(N),m.setView({lat:i,lng:d},9),v.setLatLng({lat:i,lng:d}),S(i,d),W.src=O,I.innerHTML=""},ue=()=>{document.addEventListener("keydown",$),C.addEventListener("click",A),w.appendChild(C),de()};K.addEventListener("submit",(e=>{var t,r,o;e.preventDefault(),t=ue,r=x,o=new FormData(e.target),q({url:"",method:"POST",body:o}).then(t).catch(r)})),K.querySelector(".ad-form__reset").addEventListener("click",(e=>{e.preventDefault(),de()})),L(N,(()=>{x(),b.querySelector(".error__message").textContent="Объявления не загрузились"}))})();
//# sourceMappingURL=main.bundle.js.map